generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////////////////////////////////////
// ENUM
//////////////////////////////////////////////////////////
enum Role {
  USER
  ADMIN
}

enum FileType {
  jpg
  png
  pdf
  url
}

enum EventGroup {
  ORGANIZER
  PRESENTER
  GUEST
  COMMITTEE
}

enum EventStatus {
  DRAFT
  PUBLISHED
}

//////////////////////////////////////////////////////////
// AUTH
//////////////////////////////////////////////////////////
model User {
  id            String    @id @default(uuid()) @db.Uuid
  email         String?   @unique
  username      String?   @unique
  name          String?
  image         String?
  description   String?
  role          Role      @default(USER)
  emailVerified DateTime? @db.Timestamptz(3)
  createdAt     DateTime  @default(now()) @db.Timestamptz(3)
  updatedAt     DateTime  @updatedAt @db.Timestamptz(3)

  accounts     Account[]
  sessions     Session[]
  reportsBy    UserReport[]       @relation("ReportsBy")
  reportsTo    UserReport[]       @relation("ReportsTo")
  bans         UserBan[]          @relation("BannedBy")
  participants EventParticipant[]
  rewardsGiven TeamReward[]       @relation("RewardGiver")
  comments     Comment[]
  ratings      EventRating[]
  dailyActives UserDailyActive[]
}

model Account {
  id                String  @id @default(uuid()) @db.Uuid
  userId            String  @db.Uuid
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(uuid()) @db.Uuid
  sessionToken String   @unique
  userId       String   @db.Uuid
  expires      DateTime @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////////
// EVENT CORE
//////////////////////////////////////////////////////////
model Event {
  id                     String      @id @default(uuid()) @db.Uuid
  eventName              String
  eventDescription       String?
  location               String?
  locationName           String?
  imageCover             String?
  hasCommittee           Boolean     @default(false)
  publicJoin             Boolean     @default(true)
  passwordJoin           String?
  startJoinDate          DateTime?   @db.Timestamptz(3)
  endJoinDate            DateTime?   @db.Timestamptz(3)
  publicView             Boolean     @default(true)
  startView              DateTime?   @db.Timestamptz(3)
  endView                DateTime?   @db.Timestamptz(3)
  maxTeamMembers         Int?
  virtualRewardGuest     Int         @default(0)
  virtualRewardCommittee Int         @default(0)
  unitReward             String?
  maxTeams               Int?
  status                 EventStatus @default(DRAFT)
  createdAt              DateTime    @default(now()) @db.Timestamptz(3)
  updatedAt              DateTime    @updatedAt @db.Timestamptz(3)

  participants   EventParticipant[]
  teams          Team[]
  fileTypes      EventFileType[]
  rewards        TeamReward[]
  feedbacks      CommitteeFeedback[]
  comments       Comment[]
  ratings        EventRating[]
  rankings       TeamRanking[]
  specialRewards SpecialReward[]
  linkInvite     LinkInvite?
}

//////////////////////////////////////////////////////////
// PARTICIPANTS
//////////////////////////////////////////////////////////
model EventParticipant {
  id            String     @id @default(uuid()) @db.Uuid
  eventId       String     @db.Uuid
  userId        String     @db.Uuid
  eventGroup    EventGroup?
  teamId        String?    @db.Uuid
  virtualReward Int        @default(0)
  isLeader      Boolean    @default(false)

  event     Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user      User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  team      Team?               @relation(fields: [teamId], references: [id], onDelete: Cascade)
  feedbacks CommitteeFeedback[]
  votes     SpecialRewardVote[]
}

//////////////////////////////////////////////////////////
// TEAM & PRESENTER
//////////////////////////////////////////////////////////
model Team {
  id          String   @id @default(uuid()) @db.Uuid
  eventId     String   @db.Uuid
  teamName    String
  description String?
  videoLink   String?
  imageCover  String?
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  event        Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  participants EventParticipant[]
  files        TeamFile[]
  rewards      TeamReward[]
  feedbacks    CommitteeFeedback[]
  comments     Comment[]
  rankings     TeamRanking[]
  votes        SpecialRewardVote[]
}

//////////////////////////////////////////////////////////
// FILE MANAGEMENT
//////////////////////////////////////////////////////////
model EventFileType {
  id              String   @id @default(uuid()) @db.Uuid
  eventId         String   @db.Uuid
  name            String
  description     String?
  allowedFileTypes FileType[]
  isRequired      Boolean  @default(false)
  createdAt       DateTime @default(now()) @db.Timestamptz(3)

  event     Event      @relation(fields: [eventId], references: [id], onDelete: Cascade)
  teamFiles TeamFile[]
}

model TeamFile {
  id         String   @id @default(uuid()) @db.Uuid
  teamId     String   @db.Uuid
  fileTypeId String   @db.Uuid
  fileUrl    String
  uploadedAt DateTime @default(now()) @db.Timestamptz(3)

  team     Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  fileType EventFileType @relation(fields: [fileTypeId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////////
// REWARD & FEEDBACK & COMMENT
//////////////////////////////////////////////////////////
model TeamReward {
  id        String   @id @default(uuid()) @db.Uuid
  eventId   String   @db.Uuid
  teamId    String   @db.Uuid
  giverId   String   @db.Uuid
  reward    Int
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  team  Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)
  giver User  @relation("RewardGiver", fields: [giverId], references: [id], onDelete: Cascade)
}

model CommitteeFeedback {
  id          String   @id @default(uuid()) @db.Uuid
  eventId     String   @db.Uuid
  teamId      String   @db.Uuid
  committeeId String   @db.Uuid
  content     String
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  event     Event            @relation(fields: [eventId], references: [id], onDelete: Cascade)
  team      Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)
  committee EventParticipant @relation(fields: [committeeId], references: [id], onDelete: Cascade)
}

model Comment {
  id        String   @id @default(uuid()) @db.Uuid
  eventId   String   @db.Uuid
  teamId    String?  @db.Uuid
  userId    String   @db.Uuid
  content   String
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  team  Team? @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////////
// EVENT RATING & RANKING
//////////////////////////////////////////////////////////
model EventRating {
  id        String   @id @default(uuid()) @db.Uuid
  eventId   String   @db.Uuid
  userId    String   @db.Uuid
  rating    Int
  comment   String?
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([eventId, userId]) // 1 user rate 1 event
}

model TeamRanking {
  id          String   @id @default(uuid()) @db.Uuid
  eventId     String   @db.Uuid
  teamId      String   @db.Uuid
  rank        Int
  totalReward Int
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
  team  Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)
}

model SpecialReward {
  id          String   @id @default(uuid()) @db.Uuid
  eventId     String   @db.Uuid
  name        String
  description String?
  image       String?
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  event Event               @relation(fields: [eventId], references: [id], onDelete: Cascade)
  votes SpecialRewardVote[]
}

model SpecialRewardVote {
  id          String   @id @default(uuid()) @db.Uuid
  rewardId    String   @db.Uuid
  committeeId String   @db.Uuid
  teamId      String   @db.Uuid
  createdAt   DateTime @default(now()) @db.Timestamptz(3)

  reward    SpecialReward    @relation(fields: [rewardId], references: [id], onDelete: Cascade)
  committee EventParticipant @relation(fields: [committeeId], references: [id], onDelete: Cascade)
  team      Team             @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([rewardId, committeeId])
}

//////////////////////////////////////////////////////////
// REPORT & BAN
//////////////////////////////////////////////////////////
model UserReport {
  id         String   @id @default(uuid()) @db.Uuid
  reporterId String   @db.Uuid
  reportedId String   @db.Uuid
  reason     String
  createdAt  DateTime @default(now()) @db.Timestamptz(3)

  reporter User @relation("ReportsBy", fields: [reporterId], references: [id], onDelete: Cascade)
  reported User @relation("ReportsTo", fields: [reportedId], references: [id], onDelete: Cascade)
}

model UserBan {
  id        String    @id @default(uuid()) @db.Uuid
  email     String    @unique
  reason    String?
  bannedBy  String    @db.Uuid
  createdAt DateTime  @default(now()) @db.Timestamptz(3)
  expiresAt DateTime? @db.Timestamptz(3)

  admin User @relation("BannedBy", fields: [bannedBy], references: [id], onDelete: Cascade)
}

//////////////////////////////////////////////////////////
// DAILY ACTIVE USERS
//////////////////////////////////////////////////////////
model UserDailyActive {
  id        String   @id @default(uuid()) @db.Uuid
  userId    String   @db.Uuid
  date      DateTime @db.Timestamptz(3)
  createdAt DateTime @default(now()) @db.Timestamptz(3)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, date]) // กัน user เดียวกันถูกนับซ้ำในวันเดียว
}

//////////////////////////////////////////////////////////
// Link invite
//////////////////////////////////////////////////////////
model LinkInvite {
  id             String   @id @default(uuid()) @db.Uuid
  eventId        String   @unique @db.Uuid
  createdAt      DateTime @default(now()) @db.Timestamptz(3)
  committeeToken String   @default(uuid())
  presenterToken String   @default(uuid())
  guestToken     String   @default(uuid())

  event Event @relation(fields: [eventId], references: [id], onDelete: Cascade)
}